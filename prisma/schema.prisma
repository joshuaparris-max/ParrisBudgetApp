generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PeriodType {
  WEEK
  FORTNIGHT
  MONTH
  YEAR
}

enum CategoryType {
  EXPENSE
  INCOME
}

enum ImportType {
  CSV
  PDF
}

enum ImportStatus {
  PENDING
  PARSED
  FAILED
}

enum RuleMatchType {
  CONTAINS
  REGEX
  STARTS_WITH
}

enum AlertType {
  STALE_IMPORT
  OVERSPEND
}

enum TransactionDirection {
  DEBIT
  CREDIT
}

model User {
  id           String             @id @default(uuid())
  name         String?
  email        String             @unique
  passwordHash String
  role         String             @default("member")
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  households   HouseholdMember[]
}

model Household {
  id           String             @id @default(uuid())
  name         String
  members      HouseholdMember[]
  accounts     Account[]
  imports      Import[]
  transactions Transaction[]
  categories   Category[]
  budgets      Budget[]
  rules        Rule[]
  alerts       Alert[]
  ledger       RolloverLedger[]
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
}

model HouseholdMember {
  id           String    @id @default(uuid())
  householdId  String
  userId       String
  household    Household @relation(fields: [householdId], references: [id], onDelete: Cascade)
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([householdId, userId])
}

model Account {
  id           String       @id @default(uuid())
  householdId  String
  bankName     String
  nickname     String
  household    Household    @relation(fields: [householdId], references: [id], onDelete: Cascade)
  imports      Import[]
  transactions Transaction[]
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@unique([householdId, nickname], map: "nickname_householdId")
}

model Import {
  id                    String        @id @default(uuid())
  householdId           String
  accountId             String?
  type                  ImportType
  filename              String
  uploadedAt            DateTime      @default(now())
  parsedAt              DateTime?
  status                ImportStatus  @default(PENDING)
  checksum              String?
  totalTransactions     Int           @default(0)
  processedTransactions Int           @default(0)
  failedTransactions    Int           @default(0)
  storagePath           String?
  household             Household     @relation(fields: [householdId], references: [id], onDelete: Cascade)
  account               Account?      @relation(fields: [accountId], references: [id], onDelete: SetNull)
  transactions          Transaction[]

  @@index([householdId])
  @@index([accountId])
}

model Transaction {
  id            String               @id @default(uuid())
  householdId   String
  accountId     String?
  importId      String?
  categoryId    String?
  date          DateTime
  description   String
  amount        Decimal              @db.Decimal(18, 2)
  direction     TransactionDirection
  merchantKey   String?
  externalId    String?
  dedupeHash    String
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  household     Household            @relation(fields: [householdId], references: [id], onDelete: Cascade)
  account       Account?             @relation(fields: [accountId], references: [id], onDelete: SetNull)
  import        Import?              @relation(fields: [importId], references: [id], onDelete: SetNull)
  category      Category?            @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@index([householdId, date])
  @@unique([householdId, dedupeHash])
}

model Category {
  id           String         @id @default(uuid())
  householdId  String
  name         String
  type         CategoryType
  sortOrder    Int            @default(0)
  household    Household      @relation(fields: [householdId], references: [id], onDelete: Cascade)
  budgetLines  BudgetLine[]
  rules        Rule[]
  transactions Transaction[]
  ledgerEntries RolloverLedger[]
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@unique([householdId, name])
}

model Budget {
  id          String      @id @default(uuid())
  householdId String
  periodType  PeriodType
  startsOn    DateTime
  currency    String      @default("AUD")
  household   Household   @relation(fields: [householdId], references: [id], onDelete: Cascade)
  lines       BudgetLine[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([householdId, periodType, startsOn])
}

model BudgetLine {
  id         String   @id @default(uuid())
  budgetId   String
  categoryId String
  amount     Decimal  @db.Decimal(18, 2)
  budget     Budget   @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([budgetId, categoryId])
}

model RolloverLedger {
  id          String      @id @default(uuid())
  householdId String
  categoryId  String
  periodStart DateTime
  periodType  PeriodType
  carryIn     Decimal     @db.Decimal(18, 2)
  carryOut    Decimal     @db.Decimal(18, 2)
  household   Household   @relation(fields: [householdId], references: [id], onDelete: Cascade)
  category    Category    @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  createdAt   DateTime    @default(now())

  @@unique([householdId, categoryId, periodStart, periodType])
}

model Rule {
  id          String        @id @default(uuid())
  householdId String
  categoryId  String
  matchType   RuleMatchType
  pattern     String
  priority    Int           @default(0)
  household   Household     @relation(fields: [householdId], references: [id], onDelete: Cascade)
  category    Category      @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  createdAt   DateTime      @default(now())

  @@index([householdId, priority])
}

model Alert {
  id          String    @id @default(uuid())
  householdId String
  type        AlertType
  createdAt   DateTime  @default(now())
  resolvedAt  DateTime?
  household   Household @relation(fields: [householdId], references: [id], onDelete: Cascade)

  @@index([householdId, type])
}
